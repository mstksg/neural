<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ExplicitNamespaces  #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Recurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Modify</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span> </span><span class="hs-keyword">hiding</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Index</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ix</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Neural.Recurrent.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Recurrent</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Neural.Types.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Neural.Utility.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Utility</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Proxy</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Fin</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Index</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span class="hs-operator">.</span><span class="hs-identifier">Witnesses</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Linear</span><span class="hs-operator">.</span><span class="hs-identifier">V</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">type</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-type">+</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-identifier">deleteLayer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Neural.Types.html#KnownNet"><span class="hs-identifier hs-type">KnownNet</span></a><span> </span><a href="#local-1627606390"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-1627606391"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-1627606392"><span class="hs-identifier hs-type">o</span></a><span>
</span><a name="line-26"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-1627606394"><a href="#local-1627606394"><span class="hs-identifier">j</span></a></a><span> </span><a name="local-1627606395"><a href="#local-1627606395"><span class="hs-identifier">k</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606394"><span class="hs-identifier hs-type">j</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606395"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Neural.Types.html#Node"><span class="hs-identifier hs-type">Node</span></a><span> </span><a href="#local-1627606394"><span class="hs-identifier hs-type">j</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Types.html#Node"><span class="hs-identifier hs-type">Node</span></a><span> </span><a href="#local-1627606395"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-1627606396"><a href="#local-1627606396"><span class="hs-identifier">j</span></a></a><span> </span><a name="local-1627606397"><a href="#local-1627606397"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-1627606398"><a href="#local-1627606398"><span class="hs-identifier">l</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606396"><span class="hs-identifier hs-type">j</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606397"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606398"><span class="hs-identifier hs-type">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#RNode"><span class="hs-identifier hs-type">RNode</span></a><span> </span><a href="#local-1627606396"><span class="hs-identifier hs-type">j</span></a><span> </span><a href="#local-1627606398"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#RNode"><span class="hs-identifier hs-type">RNode</span></a><span> </span><a href="#local-1627606397"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-1627606398"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Len</span><span> </span><a href="#local-1627606391"><span class="hs-identifier hs-type">hs</span></a><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#Network"><span class="hs-identifier hs-type">Network</span></a><span> </span><a href="#local-1627606390"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-1627606391"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-1627606392"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-30"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#OpaqueNet"><span class="hs-identifier hs-type">OpaqueNet</span></a><span> </span><a href="#local-1627606390"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-1627606392"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-1627606393"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-31"></a><a name="deleteLayer"><a href="Data.Neural.Recurrent.Modify.html#deleteLayer"><span class="hs-identifier">deleteLayer</span></a></a><span> </span><a name="local-1627606399"><a href="#local-1627606399"><span class="hs-identifier">mO</span></a></a><span> </span><a name="local-1627606400"><a href="#local-1627606400"><span class="hs-identifier">mI</span></a></a><span> </span><a name="local-1627606401"><a href="#local-1627606401"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-1627606402"><a href="#local-1627606402"><span class="hs-identifier">nt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-32"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627606402"><span class="hs-identifier hs-var">nt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-33"></a><span>      </span><a href="Data.Neural.Recurrent.html#NetIL"><span class="hs-identifier hs-var">NetIL</span></a><span> </span><a name="local-1627606403"><a href="#local-1627606403"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-1627606404"><a href="#local-1627606404"><span class="hs-identifier">nt'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-34"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627606401"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-35"></a><span>          </span><span class="hs-identifier hs-var">FZ</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-36"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627606404"><span class="hs-identifier hs-var">nt'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-37"></a><span>              </span><a href="Data.Neural.Recurrent.html#NetOL"><span class="hs-identifier hs-var">NetOL</span></a><span> </span><a name="local-1627606405"><a href="#local-1627606405"><span class="hs-identifier">l'</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#OpaqueNet"><span class="hs-identifier hs-var">OpaqueNet</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Neural.Recurrent.html#NetOL"><span class="hs-identifier hs-var">NetOL</span></a><span>          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-special">(</span><a href="Data.Neural.Types.html#tFLayerNodes"><span class="hs-identifier hs-var">tFLayerNodes</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapped</span><span class="hs-special">)</span><span> </span><a href="#local-1627606399"><span class="hs-identifier hs-var">mO</span></a><span> </span><a href="#local-1627606405"><span class="hs-identifier hs-var">l'</span></a><span>
</span><a name="line-38"></a><span>              </span><a href="Data.Neural.Recurrent.html#NetIL"><span class="hs-identifier hs-var">NetIL</span></a><span> </span><a name="local-1627606406"><a href="#local-1627606406"><span class="hs-identifier">l'</span></a></a><span> </span><a name="local-1627606407"><a href="#local-1627606407"><span class="hs-identifier">nt''</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#OpaqueNet"><span class="hs-identifier hs-var">OpaqueNet</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Neural.Recurrent.html#NetIL"><span class="hs-identifier hs-var">NetIL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627606407"><span class="hs-identifier hs-var">nt''</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-special">(</span><a href="Data.Neural.Recurrent.html#tRLayerNodes"><span class="hs-identifier hs-var">tRLayerNodes</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapped</span><span class="hs-special">)</span><span> </span><a href="#local-1627606400"><span class="hs-identifier hs-var">mI</span></a><span> </span><a href="#local-1627606406"><span class="hs-identifier hs-var">l'</span></a><span>
</span><a name="line-39"></a><span>          </span><span class="hs-identifier hs-var">FS</span><span> </span><a name="local-1627606408"><a href="#local-1627606408"><span class="hs-identifier">fn'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Data.Neural.Recurrent.Modify.html#deleteLayer"><span class="hs-identifier hs-var">deleteLayer</span></a><span> </span><a href="#local-1627606399"><span class="hs-identifier hs-var">mO</span></a><span> </span><a href="#local-1627606400"><span class="hs-identifier hs-var">mI</span></a><span> </span><a href="#local-1627606408"><span class="hs-identifier hs-var">fn'</span></a><span> </span><a href="#local-1627606404"><span class="hs-identifier hs-var">nt'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-40"></a><span>                      </span><a href="Data.Neural.Recurrent.html#OpaqueNet"><span class="hs-identifier hs-var">OpaqueNet</span></a><span> </span><a name="local-1627606409"><a href="#local-1627606409"><span class="hs-identifier">ntD</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Neural.Recurrent.html#OpaqueNet"><span class="hs-identifier hs-var">OpaqueNet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627606403"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="Data.Neural.Recurrent.html#NetIL"><span class="hs-identifier hs-var">NetIL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627606409"><span class="hs-identifier hs-var">ntD</span></a><span>
</span><a name="line-41"></a><span>      </span><a href="Data.Neural.Recurrent.html#NetOL"><span class="hs-identifier hs-var">NetOL</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;impossible!&quot;</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">addLayer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Data.Neural.Types.html#KnownNet"><span class="hs-identifier hs-type">KnownNet</span></a><span> </span><a href="#local-1627606381"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-1627606382"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-1627606383"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606384"><span class="hs-identifier hs-type">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-1627606386"><a href="#local-1627606386"><span class="hs-identifier">j</span></a></a><span> </span><a name="local-1627606387"><a href="#local-1627606387"><span class="hs-identifier">k</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606386"><span class="hs-identifier hs-type">j</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606387"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Neural.Recurrent.html#RLayer"><span class="hs-identifier hs-type">RLayer</span></a><span> </span><a href="#local-1627606386"><span class="hs-identifier hs-type">j</span></a><span> </span><a href="#local-1627606384"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606385"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Data.Neural.Types.html#FLayer"><span class="hs-identifier hs-type">FLayer</span></a><span> </span><a href="#local-1627606384"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606387"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-1627606385"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-1627606388"><a href="#local-1627606388"><span class="hs-identifier">j</span></a></a><span> </span><a name="local-1627606389"><a href="#local-1627606389"><span class="hs-identifier">k</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606388"><span class="hs-identifier hs-type">j</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-1627606389"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Neural.Recurrent.html#RLayer"><span class="hs-identifier hs-type">RLayer</span></a><span> </span><a href="#local-1627606388"><span class="hs-identifier hs-type">j</span></a><span> </span><a href="#local-1627606384"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606385"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Data.Neural.Recurrent.html#RLayer"><span class="hs-identifier hs-type">RLayer</span></a><span> </span><a href="#local-1627606384"><span class="hs-identifier hs-type">l</span></a><span> </span><a href="#local-1627606389"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-1627606385"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Len</span><span> </span><span class="hs-special">(</span><a href="#local-1627606381"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-char">': hs))
         -&gt; Network i hs o a
         -&gt; OpaqueNet i o a
addLayer mO mI fn nt =
    case fn of
      FZ -&gt;
        case nt of
          NetOL _     -&gt; let (li, lo) = mO
                         in  OpaqueNet $ li `NetIL` NetOL lo
          NetIL _ nt' -&gt; let (li, lo) = mI
                         in  OpaqueNet $ li `NetIL` lo `NetIL` nt'
      FS fn' -&gt;
        case nt of
          NetIL l nt' -&gt;
            case addLayer mO mI fn' nt' of
              OpaqueNet ntA -&gt; OpaqueNet $ l `NetIL` ntA
          NetOL _ -&gt; error &quot;impossible!&quot;

deleteNode :: forall i hs h o a. KnownNet i hs o
           =&gt; Index hs h
           -&gt; Finite h
           -&gt; Network i hs o a
           -&gt; OpaqueNet i o a
deleteNode ix fn nt =
    case ix of
      IZ -&gt;
        case nt of
          NetIL (l :: RLayer i h a) nt' -&gt;
            withNatOp (%-) (Proxy :: Proxy h) (Proxy :: Proxy 1) $
              let lD :: RLayer i (h - 1) a
                  lD = RLayer (over (traverse . tRNodeSWeights) (deleteV fn)
                                . deleteV fn
                                $ rLayerNodes l)
                              (deleteV fn $ rLayerState l)
              in  case nt' of
                    NetOL l' -&gt;
                      let l'D :: FLayer (h - 1) o a
                          l'D = over (tFLayerNodes . traverse . tNodeWeights) (deleteV fn) l'
                      in  OpaqueNet $ lD `NetIL` NetOL l'D
                    NetIL (l' :: RLayer h j a) nt'' -&gt;
                      let l'D :: RLayer (h - 1) j a
                          l'D = RLayer (over (traverse . tRNodeIWeights) (deleteV fn)
                                         $ rLayerNodes l' )
                                       (rLayerState l')
                      in  OpaqueNet $ lD `NetIL` l'D `NetIL` nt''
      IS ix' -&gt;
        case nt of
          NetIL l nt' -&gt;
            case deleteNode ix' fn nt' of
              OpaqueNet ntD -&gt; OpaqueNet $ l `NetIL` ntD

addNode :: forall i hs o a. KnownNet i hs o
        =&gt; (forall j l. (KnownNat j, KnownNat l, KnownNat (l + 1)) =&gt; (RNode j (l + 1) a, V l a, a))
        -&gt; (forall k. KnownNat k =&gt; V k a)
        -&gt; Fin (Len hs)
        -&gt; Network i hs o a
        -&gt; OpaqueNet i o a
addNode mInp mOut fn nt =
    case nt of
      NetIL (l :: RLayer i j a) nt' -&gt;
        case fn of
          FZ -&gt; withNatOp (%+) (Proxy :: Proxy j) (Proxy :: Proxy 1) $
            let (lNew, wsNew, sNew) = mInp
                lA :: RLayer i (j + 1) a
                lA = RLayer ((`snocV` lNew)
                              . liftA2 (\w -&gt; over tRNodeSWeights (`snocV` w)) wsNew
                              $ rLayerNodes l)
                            (rLayerState l `snocV` sNew)
            in  case nt' of
                  NetOL l' -&gt;
                    let l'A :: FLayer (j + 1) o a
                        l'A = FLayer $ liftA2 (\w -&gt; over tNodeWeights (`snocV` w)) mOut $ layerNodes l'
                    in  OpaqueNet $ lA `NetIL` NetOL l'A
                  NetIL (l' :: RLayer j k a) nt'' -&gt;
                    let l'A :: RLayer (j + 1) k a
                        l'A = RLayer (liftA2 (\w -&gt; over tRNodeIWeights (`snocV` w)) mOut $ rLayerNodes l')
                                     (rLayerState l')
                    in  OpaqueNet $ lA `NetIL` l'A `NetIL` nt''
          FS fn' -&gt; case addNode mInp mOut fn' nt' of
                      OpaqueNet ntA -&gt; OpaqueNet $ l `NetIL` ntA
      NetOL _ -&gt; error &quot;impossible!&quot;
</span></pre></body></html>